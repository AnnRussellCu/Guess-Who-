<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guess the MEME - Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Dokdo&family=Bungee+Inline&display=swap" rel="stylesheet"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#1E1E2F;
      color:white;
      font-family:'Dokdo', sans-serif;
      height:100vh;
      overflow:hidden;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .back {
      position: absolute;
      top: 27px;
      left: 14px;
      display: flex;
      gap: 7px;
      align-items: center;
      cursor: pointer;
      font-family: 'Bungee Inline';
      font-size: 32px;
      color: #fff;
      z-index: 100;
    }
    .back:hover { opacity:0.8; }

    main {
      width: 1440px;
      min-height: 1024px;
      position: relative;
      padding: 40px 60px;
    }
    #turnIndicator {
      position: absolute;
      top: 79px;
      left: 210px;
      font-size: 64px;
      color: #fff;
    }

    .game-grid {
      position: absolute;
      top: 214px;
      left: 60px;
      width: 850px;
      display: grid;
      grid-template-columns: repeat(5, 152px);
      grid-template-rows: repeat(3, 195px);
      gap: 25px 23px;
    }
    .game-card {
      width: 152px;
      height: 195px;
      position: relative;
      cursor: pointer;
      transition: transform .2s;
    }
    .game-card:hover { transform: scale(1.05); }
    .game-card.crossed {
      opacity: 0.4;
    }
    .game-card.crossed::after {
      content: "";
      position: absolute;
      inset: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><line x1="10" y1="90" x2="90" y2="10" stroke="red" stroke-width="10"/><line x1="10" y1="10" x2="90" y2="90" stroke="red" stroke-width="10"/></svg>') center/80% no-repeat;
    }
    .card-bg {
      position: absolute;
      inset: 0;
      border-radius: 20px;
    }
    .bg-yellow { background:#facc15; }
    .bg-red    { background:#f87171; }
    .bg-blue   { background:#60a5fa; }
    .bg-green  { background:#4ade80; }
    .game-card img {
      position: absolute;
      top: 15px;
      left: 11px;
      width: 130px;
      height: 130px;
      pointer-events: none;
    }
    .card-name {
      position: absolute;
      bottom: 15px;
      left: 0;
      width: 100%;
      text-align: center;
      font-family: 'Bungee Inline', cursive;
      color: #000;
      font-size: 15px;
      pointer-events: none;
    }

    .opponent-area {
      position: absolute;
      top: 60px;
      left: 1012px;
      width: 378px;
      height: 195px;
      display: flex;
      gap: 31px;
      align-items: center;
    }
    .opponent-info {
      font-size: 20px;
      line-height: 1.6;
      width: 195px;
    }
    .target-card {
      width: 150px;
      height: 195px;
      background: #facc15;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .target-card img {
      width: 130px;
      height: 130px;
    }

    .chat-box {
      position: absolute;
      top: 291px;
      left: 973px;
      width: 421px;
      height: 680px;
      background: #374151;
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      font-size: 24px;
      margin-bottom: 15px;
    }
    .msg { margin: 8px 0; }
    .msg.you { color: #de7d4a; }
    .msg.opponent { color: #a78bfa; }
    .msg.system { color: #fff; }
    #messageForm {
      display: flex;
      gap: 10px;
    }
    #chatInput {
      flex: 1;
      padding: 12px 15px;
      background: #d9d9d9;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      outline: none;
    }
    #sendBtn {
      width: 54px;
      height: 54px;
      background: #a78bfa;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
      font-size: 24px;
    }

    .action-buttons {
      position: absolute;
      top: 901px;
      display: flex;
      gap: 113px;
    }
    .action-btn {
      width: 237px;
      height: 60px;
      position: relative;
    }
    .action-btn button {
      width: 235px;
      height: 60px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Bungee Inline', cursive;
      font-size: 24px;
      color: #fff;
      transition: all .2s;
    }
    #resetBtn {
      left: 192px;
    }
    #resetBtn button {
      background: #de7d4a;
    }
    #resetBtn button:hover { background:#d06d3a; }
    #guessBtn {
      left: 542px;
    }
    #guessBtn button {
      background: #a78bfa;
    }
    #guessBtn button:hover { background:#9370db; }

    .hint {
      position: absolute;
      top: 1006px;
      left: 12px;
      font-size: 15px;
      color: #fff;
    }
  </style>
</head>
<body>

  <div class="back" onclick="location.href='/'">Back</div>

  <main>
    <h1 id="turnIndicator">Your turn.</h1>

    <div class="game-grid" id="gameGrid"></div>

    <div class="opponent-area">
      <div class="opponent-info">
        Your opponent's meme:<br>
        <span id="oppName">???</span><br><br>
        Guess which one it is!
      </div>
      <div class="target-card"><img id="oppImg" src="" alt=""/></div>
    </div>

    <div class="chat-box">
      <div id="chatMessages">
        <div class="msg system">Game started!</div>
      </div>
      <form id="messageForm">
        <input type="text" id="chatInput" placeholder="Ask a question..." autocomplete="off"/>
        <button id="sendBtn" type="submit">âž¤</button>
      </form>
    </div>

    <div class="action-buttons">
      <div class="action-btn" id="resetBtn"><button>Reset board</button></div>
      <div class="action-btn" id="guessBtn"><button>it's you!</button></div>
    </div>

    <div class="hint">Hint: Double-click a card to cross it out</div>
  </main>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(location.search);
    const roomCode = params.get('room');
    const username = params.get('username');
    const myChoiceId = parseInt(params.get('choice'));

    if (!roomCode || !username || !myChoiceId) {
      alert("Missing game data. Returning to menu...");
      location.href = '/';
    }

    socket.emit('join_game_room', { room_code: roomCode, username });

    const memes = [
      {id:1, name:"Doubter", img:"static/img/1.png", color:"yellow"},
      {id:2, name:"Conspiracy Keanu", img:"static/img/2.png", color:"red"},
      {id:3, name:"Mini Keanu", img:"static/img/3.png", color:"blue"},
      {id:4, name:"Eye Roll", img:"static/img/4.png", color:"green"},
      {id:5, name:"Guard", img:"static/img/5.png", color:"yellow"},
      {id:6, name:"Pointing Glasses", img:"static/img/6.png", color:"red"},
      {id:7, name:"Looking Guy", img:"static/img/7.png", color:"blue"},
      {id:8, name:"Borat Thumbs", img:"static/img/8.png", color:"green"},
      {id:9, name:"Confused Woman", img:"static/img/9.png", color:"yellow"},
      {id:10, name:"Smirk", img:"static/img/10.png", color:"red"},
      {id:11, name:"Roll Safe", img:"static/img/11.png", color:"blue"},
      {id:12, name:"Gandalf", img:"static/img/12.png", color:"green"},
      {id:13, name:"Sad Affleck", img:"static/img/13.png", color:"yellow"},
      {id:14, name:"Tada Man", img:"static/img/14.png", color:"red"},
      {id:15, name:"Confused Gandalf", img:"static/img/15.png", color:"blue"}
    ];

    let opponentChoice = null;
    let isMyTurn = false;

    // Build the grid
    const grid = document.getElementById('gameGrid');
    memes.forEach(m => {
      const card = document.createElement('div');
      card.className = 'game-card';
      card.dataset.id = m.id;
      card.innerHTML = `
        <div class="card-bg bg-${m.color}"></div>
        <img src="${m.img}" alt="${m.name}"/>
        <div class="card-name">${m.name}</div>
      `;
      card.ondblclick = () => card.classList.toggle('crossed');
      card.onclick = () => { if (isMyTurn) makeGuess(m.id); };
      grid.appendChild(card);
    });

    // Receive opponent's choice
    socket.on('choices_finalized', data => {
      for (const [user, choiceId] of Object.entries(data.choices)) {
        if (user !== username) {
          opponentChoice = memes.find(m => m.id === choiceId);
          document.getElementById('oppImg').src = opponentChoice.img;
          document.getElementById('oppName').textContent = '???';
        }
      }
    });

    // Chat messages
    socket.on('chat_message', d => {
      const div = document.createElement('div');
      div.className = `msg ${d.username === username ? 'you' : 'opponent'}`;
      div.textContent = `${d.username}: ${d.message}`;
      document.getElementById('chatMessages').appendChild(div);
      div.scrollIntoView();
    });

    document.getElementById('messageForm').onsubmit = e => {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      if (!input.value.trim() || !isMyTurn) return;
      socket.emit('chat_message', { room_code: roomCode, username, message: input.value });
      input.value = '';
    };

    // Turn management
    const updateTurn = myTurn => {
      isMyTurn = myTurn;
      document.getElementById('turnIndicator').textContent = myTurn ? 'Your turn.' : "Opponent's turn...";
      document.getElementById('chatInput').disabled = !myTurn;
    };
    socket.on('turn_update', d => updateTurn(d.current_turn === username));

    // Make guess
    const makeGuess = id => {
      socket.emit('make_guess', { room_code: roomCode, username, guessed_id: id });
    };

    socket.on('guess_result', d => {
      if (d.success) {
        alert(`Correct! You win! It was ${d.correct_meme_name}`);
      } else {
        alert('Wrong guess!');
      }
    });

    // Reset board
    document.querySelector('#resetBtn button').onclick = () => {
      document.querySelectorAll('.game-card.crossed').forEach(c => c.classList.remove('crossed'));
    };

    // Game over - redirect to result
    socket.on('game_over', d => {
      setTimeout(() => {
        location.href = `/result.html?room=${roomCode}&username=${encodeURIComponent(username)}`;
      }, 2000);
    });
  </script>
</body>
</html>