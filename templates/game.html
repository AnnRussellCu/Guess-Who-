<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guess the MEME - Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Dokdo&family=Bungee+Inline&display=swap" rel="stylesheet"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#1E1E2F;
      color:white;
      font-family:'Dokdo', sans-serif;
      height:100vh;
      overflow:hidden;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    
    .back {
      position: absolute;
      top: 1.5vh;
      left: 1vw;
      display: flex;
      gap: 0.5vw;
      align-items: center;
      cursor: pointer;
      font-family: 'Bungee Inline';
      font-size: clamp(18px, 1.8vw, 32px);
      color: #fff;
      z-index: 100;
    }
    .back:hover { opacity:0.8; }

    .help {
      position: absolute;
      top: 1.5vh;
      right: 1vw;
      display: flex;
      align-items: center;
      justify-content: center;
      width: clamp(35px, 3.5vw, 50px);
      height: clamp(35px, 3.5vw, 50px);
      font-family: 'Bungee Inline';
      font-size: clamp(18px, 2vw, 28px);
      color: #fff;
      background: #60A5FA;
      border-radius: 50%;
      cursor: pointer;
      z-index: 100;
      user-select: none;
      text-align: center;
    }

    .help:hover {
      opacity: 0.8;
    }

    main {
      width: 95vw;
      max-width: 1400px;
      height: 95vh;
      position: relative;
      padding: 2vh 2vw;
      display: flex;
      flex-direction: column;
    }
    
    #turnIndicator {
      font-size: clamp(32px, 4vh, 64px);
      color: #fff;
      margin-bottom: 2vh;
      text-align: center;
    }

    .content-wrapper {
      display: flex;
      gap: 2vw;
      height: 100%;
    }

    .left-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .game-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: clamp(10px, 1.5vh, 25px) clamp(8px, 1vw, 23px);
      flex: 1;
    }
    
    .game-card {
      width: 100%;
      height: 100%;
      max-width: 152px;
      max-height: 195px;
      position: relative;
      cursor: pointer;
      transition: all .25s ease;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .game-card:hover:not(.selected):not(.crossed) {
      transform: scale(1.08);
      z-index: 10;
    }

    .game-card.selected {
      transform: scale(1.15);
      z-index: 20;
      box-shadow: 0 0 30px #a78bfa, inset 0 0 20px rgba(167,139,250,0.4);
      outline: 5px solid #a78bfa;
      outline-offset: 4px;
    }

    .game-card.crossed {
      opacity: 0.4;
    }
    .game-card.crossed::after {
      content: "";
      position: absolute;
      inset: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><line x1="10" y1="90" x2="90" y2="10" stroke="red" stroke-width="12"/><line x1="10" y1="10" x2="90" y2="90" stroke="red" stroke-width="12"/></svg>') center/85% no-repeat;
    }

    .card-bg {
      position: absolute;
      inset: 0;
      border-radius: 20px;
    }
    .bg-yellow { background:#facc15; }
    .bg-red    { background:#f87171; }
    .bg-blue   { background:#60a5fa; }
    .bg-green  { background:#4ade80; }
    
    .game-card img {
      position: absolute;
      top: 10%;
      left: 7%;
      width: 86%;
      height: 67%;
      object-fit: contain;
    }
    
    .card-name {
      position: absolute;
      bottom: 8%;
      left: 0;
      width: 100%;
      text-align: center;
      font-family: 'Bungee Inline', cursive;
      color: #000;
      font-size: clamp(10px, 1vw, 15px);
      pointer-events: none;
    }

    .action-buttons {
      display: flex;
      gap: clamp(15px, 2vw, 30px);
      justify-content: center;
      margin-top: 2vh;
    }
    
    .action-btn button {
      width: clamp(130px, 13vw, 200px);
      height: clamp(40px, 5vh, 60px);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Bungee Inline', cursive;
      font-size: clamp(12px, 1.3vw, 20px);
      color: #fff;
      transition: all .2s;
    }
    
    .action-btn button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #resetBtn button { background: #de7d4a; }
    #resetBtn button:hover:not(:disabled) { background:#d06d3a; }
    #guessBtn button { background: #a78bfa; }
    #guessBtn button:hover:not(:disabled) { background:#9370db; }
    #skipBtn button { background: #60a5fa; }
    #skipBtn button:hover:not(:disabled) { background:#3b82f6; }

    .hint {
      text-align: center;
      margin-top: 1vh;
      font-size: clamp(12px, 1.2vw, 15px);
      color: #fff;
    }

    .right-section {
      width: clamp(300px, 28vw, 421px);
      display: flex;
      flex-direction: column;
      gap: 2vh;
    }

    .your-card-area {
      background: rgba(167, 139, 250, 0.15);
      border: 2px solid #a78bfa;
      border-radius: 15px;
      padding: 1.5vh 1vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1vh;
    }
    
    .your-card-title {
      font-family: 'Bungee Inline';
      font-size: clamp(16px, 1.8vw, 24px);
      color: #a78bfa;
      text-align: center;
    }
    
    .your-card-display {
      width: clamp(100px, 10vw, 150px);
      height: clamp(130px, 13vh, 195px);
      background: #facc15;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .your-card-display .card-bg {
      position: absolute;
      inset: 0;
      border-radius: 15px;
      z-index: 1;
    }

    .your-card-display img {
      width: 85%;
      height: 65%;
      object-fit: contain;
      position: relative;
      z-index: 2;
    }

    .your-card-name {
      font-family: 'Bungee Inline';
      font-size: clamp(12px, 1.2vw, 16px);
      color: #fff;
      text-align: center;
    }

    .chat-box {
      flex: 1;
      background: #374151;
      border-radius: 10px;
      padding: 1.5vh 1vw;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      font-size: clamp(16px, 1.8vw, 24px);
      margin-bottom: 1vh;
      min-height: 0;
    }
    
    .msg { 
      margin: 0.5vh 0;
      word-wrap: break-word;
    }
    .msg.you { color: #de7d4a; }
    .msg.opponent { color: #a78bfa; }
    .msg.system { color: #fff; }
    .msg.error { color: #f87171; font-style: italic; }
    
    #messageForm {
      display: flex;
      gap: 1vw;
    }
    
    #chatInput {
      flex: 1;
      padding: clamp(8px, 1vh, 12px) clamp(10px, 1vw, 15px);
      background: #d9d9d9;
      border: none;
      border-radius: 10px;
      font-size: clamp(14px, 1.4vw, 16px);
      font-family: 'Bungee Inline', cursive;
      outline: none;
    }
    
    #chatInput::placeholder {
      color: #37415180;
    }
    
    #sendBtn {
      width: clamp(40px, 4vw, 54px);
      height: clamp(40px, 4vw, 54px);
      background: #a78bfa;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
      font-size: clamp(18px, 2vw, 24px);
      transition: all .2s;
    }
    
    #sendBtn:hover {
      background: #9370db;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 30, 47, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #1E1E2F;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      color: #fff;
      box-shadow: 0 0 20px #000;
      max-width: 500px;
      width: 85vw;
    }

    .modal-text {
      font-family: 'Bungee Inline', cursive;
      font-size: clamp(24px, 4vw, 36px);
      margin-bottom: 20px;
      color: #a78bfa;
    }

    .modal-message {
      font-family: 'Dokdo', cursive;
      font-size: clamp(18px, 3vw, 28px);
      margin-bottom: 30px;
      color: #fff;
      line-height: 1.4;
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .modal-buttons button {
      font-family: 'Bungee Inline', cursive;
      font-size: clamp(18px, 2.5vw, 28px);
      padding: 10px 30px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.3s;
      color: #fff;
      min-width: 120px;
    }

    .modal-buttons .btn-primary {
      background: #10B981;
    }

    .modal-buttons .btn-primary:hover {
      background: #059669;
    }

    .modal-buttons .btn-secondary {
      background: #EF4444;
    }

    .modal-buttons .btn-secondary:hover {
      background: #DC2626;
    }

    .modal-buttons .btn-info {
      background: #60A5FA;
    }

    .modal-buttons .btn-info:hover {
      background: #3B82F6;
    }

    /* Instructions Modal - full screen */
    #instructionsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 30, 47, 0.95);
      z-index: 2000;
      overflow-y: auto;
    }

    #instructionsModal.active {
      display: block;
    }

    #instructionsModal iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .close-instructions {
      position: fixed;
      top: 27px;
      left: 14px;
      display: flex;
      gap: 7px;
      align-items: center;
      cursor: pointer;
      font-family: 'Bungee Inline';
      font-size: 32px;
      color: #fff;
      z-index: 2001;
      transition: opacity 0.2s;
    }

    .close-instructions:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body>

<div class="back" onclick="surrenderGame()">Surrender</div>
<div class="help" onclick="openInstructions()">?</div>

<div id="gameModal" class="modal">
  <div class="modal-content">
    <div class="modal-text" id="modalTitle">Alert</div>
    <div class="modal-message" id="modalMessage"></div>
    <div class="modal-buttons" id="modalButtons">
      <button class="btn-primary" onclick="closeModal()">OK</button>
    </div>
  </div>
</div>

<div id="instructionsModal">
  <div class="close-instructions" onclick="closeInstructions()">back</div>
  <iframe id="instructionsFrame" src=""></iframe>
</div>

<main>
  <h1 id="turnIndicator">Loading...</h1>

  <div class="content-wrapper">
    <div class="left-section">
      <div class="game-grid" id="gameGrid"></div>
      <div class="action-buttons">
        <div class="action-btn" id="resetBtn"><button>Reset board</button></div>
        <div class="action-btn" id="skipBtn"><button>Skip turn</button></div>
        <div class="action-btn" id="guessBtn"><button>it's you!</button></div>
      </div>
      <div class="hint">Hint: Double-click a card to cross it out â€¢ Click once to select</div>
    </div>

    <div class="right-section">
      <div class="your-card-area">
        <div class="your-card-title">YOUR MEME:</div>
        <div class="your-card-display" id="yourCard">
          <div class="card-bg" id="yourCardBg"></div>
          <img id="yourCardImg" src="" alt=""/>
        </div>
        <div class="your-card-name" id="yourCardName"></div>
      </div>

      <div class="chat-box">
        <div id="chatMessages">
          <div class="msg system">Game started!</div>
          <div class="msg system">Remember: Only YES/NO questions allowed!</div>
        </div>
        <form id="messageForm">
          <input type="text" id="chatInput" placeholder="Ask a yes/no question..." autocomplete="off"/>
          <button id="sendBtn" type="submit">âž¤</button>
        </form>
      </div>
    </div>
  </div>
</main>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    // Force new connection for each client
    const socket = io({
      transports: ['websocket', 'polling'],
      upgrade: true,
      rememberUpgrade: true,
      forceNew: true
    });
    
    socket.on('connect', () => {
      console.log(`[SOCKET] Connected with ID: ${socket.id}`);
    });
    
    socket.on('disconnect', () => {
      console.log(`[SOCKET] Disconnected`);
    });
    
    const params = new URLSearchParams(location.search);
    const roomCode = params.get('room');
    const username = params.get('username');
    const myChoiceId = parseInt(params.get('choice'));
    const firstTurn = params.get('turn');
    
    console.log(`[GAME] Initializing - Room: ${roomCode}, Username: ${username}, Choice: ${myChoiceId}, FirstTurn: ${firstTurn}`);
    let selectedCard = null;
    let isMyTurn = false;
    let opponentUsername = null;
    let turnInitialized = false;
    let myWrongGuesses = 0;
    let crossedCards = new Set(); // Track crossed cards
    let roomPlayers = []; // Store all players in room

    // Load saved state on page load
    window.addEventListener('DOMContentLoaded', () => {
      const savedState = sessionStorage.getItem(`gameState_${roomCode}`);
      if (savedState) {
        const state = JSON.parse(savedState);
        crossedCards = new Set(state.crossedCards || []);
        myWrongGuesses = state.wrongGuesses || 0;
        
        // Restore crossed cards after grid is created
        setTimeout(() => {
          crossedCards.forEach(cardId => {
            const card = document.querySelector(`.game-card[data-id="${cardId}"]`);
            if (card) card.classList.add('crossed');
          });
        }, 100);
      }
    });

    // Save state before leaving
    function saveGameState() {
      const state = {
        crossedCards: Array.from(crossedCards),
        wrongGuesses: myWrongGuesses
      };
      sessionStorage.setItem(`gameState_${roomCode}`, JSON.stringify(state));
    }

    if (!roomCode || !username || !myChoiceId) {
      console.error('[GAME] Missing required parameters!', {roomCode, username, myChoiceId});
      showModal('Error', 'Missing game data. Returning to menu...');
      setTimeout(() => location.href = '/', 2000);
    } else {
      console.log('[GAME] All parameters valid, continuing...');
    }

    socket.emit('join_game_room', { room_code: roomCode, username });

    // Listen for player list updates
    socket.on('update_players', players => {
      roomPlayers = players;
      opponentUsername = players.find(p => p !== username);
      console.log(`[GAME] Players in room: ${players}, Opponent: ${opponentUsername}`);
    });

    const memes = [
      {id:1, name:"Doubter", img:"/static/img/1.png", color:"yellow"},
      {id:2, name:"Conspiracy Keanu", img:"/static/img/2.png", color:"red"},
      {id:3, name:"Mini Keanu", img:"/static/img/3.png", color:"blue"},
      {id:4, name:"Eye Roll", img:"/static/img/4.png", color:"green"},
      {id:5, name:"Guard", img:"/static/img/5.png", color:"yellow"},
      {id:6, name:"Pointing Glasses", img:"/static/img/6.png", color:"red"},
      {id:7, name:"Looking Guy", img:"/static/img/7.png", color:"blue"},
      {id:8, name:"Borat Thumbs", img:"/static/img/8.png", color:"green"},
      {id:9, name:"Confused Woman", img:"/static/img/9.png", color:"yellow"},
      {id:10, name:"Smirk", img:"/static/img/10.png", color:"red"},
      {id:11, name:"Roll Safe", img:"/static/img/11.png", color:"blue"},
      {id:12, name:"Gandalf", img:"/static/img/12.png", color:"green"},
      {id:13, name:"Sad Affleck", img:"/static/img/13.png", color:"yellow"},
      {id:14, name:"Tada Man", img:"/static/img/14.png", color:"red"},
      {id:15, name:"Confused Gandalf", img:"/static/img/15.png", color:"blue"}
    ];

    function showModal(title, message, isConfirm = false) {
      return new Promise((resolve) => {
        const modal = document.getElementById('gameModal');
        const titleEl = document.getElementById('modalTitle');
        const messageEl = document.getElementById('modalMessage');
        const buttonsEl = document.getElementById('modalButtons');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        if (isConfirm) {
          buttonsEl.innerHTML = `
            <button class="btn-primary" onclick="confirmModal(true)">Yes</button>
            <button class="btn-secondary" onclick="confirmModal(false)">No</button>
          `;
          window.modalConfirmResolve = resolve;
        } else {
          buttonsEl.innerHTML = '<button class="btn-primary" onclick="closeModal()">OK</button>';
          window.modalResolve = resolve;
        }
        
        modal.style.display = 'flex';
      });
    }

    function closeModal() {
      document.getElementById('gameModal').style.display = 'none';
      if (window.modalResolve) {
        window.modalResolve();
        window.modalResolve = null;
      }
    }

    function confirmModal(result) {
      document.getElementById('gameModal').style.display = 'none';
      if (window.modalConfirmResolve) {
        window.modalConfirmResolve(result);
        window.modalConfirmResolve = null;
      }
    }

    window.onclick = (event) => {
      const modal = document.getElementById('gameModal');
      if (event.target === modal) closeModal();
    };

    function openInstructions() {
      saveGameState();
      const modal = document.getElementById('instructionsModal');
      const iframe = document.getElementById('instructionsFrame');
      iframe.src = '/instructions';
      modal.classList.add('active');
    }

    function closeInstructions() {
      const modal = document.getElementById('instructionsModal');
      modal.classList.remove('active');
      document.getElementById('instructionsFrame').src = '';
    }

    const myMeme = memes.find(m => m.id === myChoiceId);
    if (myMeme) {
      document.getElementById('yourCardImg').src = myMeme.img;
      document.getElementById('yourCardName').textContent = myMeme.name;
      document.getElementById('yourCardBg').className = `card-bg bg-${myMeme.color}`;
    }

    const grid = document.getElementById('gameGrid');
    memes.forEach(m => {
      const card = document.createElement('div');
      card.className = 'game-card';
      card.dataset.id = m.id;
      card.innerHTML = `
        <div class="card-bg bg-${m.color}"></div>
        <img src="${m.img}" alt="${m.name}"/>
        <div class="card-name">${m.name}</div>
      `;

      card.ondblclick = (e) => {
        e.stopPropagation();
        card.classList.toggle('crossed');
        
        // Update tracked crossed cards
        const cardId = parseInt(card.dataset.id);
        if (card.classList.contains('crossed')) {
          crossedCards.add(cardId);
        } else {
          crossedCards.delete(cardId);
        }
        saveGameState();
        
        if (card.classList.contains('selected')) {
          card.classList.remove('selected');
          selectedCard = null;
        }
      };

      card.onclick = () => {
        if (!isMyTurn) return;
        
        if (card.classList.contains('selected')) {
          card.classList.remove('selected');
          selectedCard = null;
          return;
        }

        document.querySelectorAll('.game-card.selected').forEach(c => c.classList.remove('selected'));
        
        if (!card.classList.contains('crossed')) {
          card.classList.add('selected');
          selectedCard = parseInt(card.dataset.id);
        }
      };

      grid.appendChild(card);
    });

    const guessBtn = document.querySelector('#guessBtn button');
    const resetBtn = document.querySelector('#resetBtn button');
    const skipBtn = document.querySelector('#skipBtn button');
    const chatInput = document.getElementById('chatInput');

    function updateTurnUI(myTurnNow) {
        isMyTurn = myTurnNow;
        const indicator = document.getElementById('turnIndicator');
        indicator.textContent = isMyTurn ? 'Your turn.' : "Opponent's turn.";
        
        console.log(`[TURN] Turn updated - isMyTurn: ${isMyTurn}, Username: ${username}`);

        guessBtn.disabled = !isMyTurn;
        skipBtn.disabled = !isMyTurn;

        if (!isMyTurn) {
            document.querySelectorAll('.game-card.selected').forEach(c => c.classList.remove('selected'));
            selectedCard = null;
        }
    }

    if (firstTurn) {
      const myTurnNow = firstTurn === username;
      console.log(`[TURN] Initial turn setup - firstTurn: ${firstTurn}, myTurnNow: ${myTurnNow}`);
      updateTurnUI(myTurnNow);
      turnInitialized = true;
    }

    socket.on('turn_update', data => {
      console.log(`[TURN] Received turn_update - current_turn: ${data.current_turn}, my username: ${username}`);
      const myTurnNow = data.current_turn === username;
      updateTurnUI(myTurnNow);
    });

    setTimeout(() => {
      if (!turnInitialized) {
        console.log(`[TURN] Turn not initialized, requesting update from server`);
        socket.emit('request_turn_update', { room_code: roomCode });
      }
    }, 500);

    guessBtn.onclick = async () => {
      if (!isMyTurn) {
        await showModal('Not Your Turn', "Wait for your turn!");
        return;
      }
      if (!selectedCard) {
        await showModal('No Selection', "Select a card first by clicking on it!");
        return;
      }

      guessBtn.disabled = true;
      skipBtn.disabled = true;

      socket.emit('make_guess', { room_code: roomCode, username, guessed_id: selectedCard });
      
      document.querySelectorAll('.game-card.selected').forEach(c => c.classList.remove('selected'));
      selectedCard = null;
    };

    skipBtn.onclick = async () => {
      if (!isMyTurn) {
        await showModal('Not Your Turn', "Wait for your turn!");
        return;
      }
      
      const confirmed = await showModal('Skip Turn?', 'Pass your turn to the opponent?', true);
      if (confirmed) {
        socket.emit('skip_turn', { room_code: roomCode, username });
        document.querySelectorAll('.game-card.selected').forEach(c => c.classList.remove('selected'));
        selectedCard = null;
        guessBtn.disabled = true;
        skipBtn.disabled = true;
      }
    };

    resetBtn.onclick = () => {
      document.querySelectorAll('.game-card.crossed').forEach(c => c.classList.remove('crossed'));
      crossedCards.clear();
      saveGameState();
    };

    socket.on('question_rejected', data => {
      const div = document.createElement('div');
      div.className = 'msg error';
      div.textContent = `âŒ ${data.reason}`;
      document.getElementById('chatMessages').appendChild(div);
      document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    });

    socket.on('chat_message', data => {
      const div = document.createElement('div');
      if (data.username === 'System') {
        div.className = 'msg system';
        div.textContent = `ðŸ’¬ ${data.message}`;
      } else {
        const isMe = data.username === username;
        div.className = `msg ${isMe ? 'you' : 'opponent'}`;
        const sender = isMe ? "You" : "Opponent";
        div.textContent = `${sender}: ${data.message}`;
      }
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    document.getElementById('messageForm').onsubmit = e => {
      e.preventDefault();
      if (!chatInput.value.trim()) return;
      socket.emit('chat_message', { 
        room_code: roomCode, 
        username, 
        message: chatInput.value.trim() 
      });
      chatInput.value = '';
    };

    socket.on('guess_result', async data => {
        if (data.success) {
            const winner = data.guesser === username ? "You" : "Opponent";
            await showModal('Victory!', `Correct! ${winner} wins! It was ${data.correct_meme_name}`);
        } else {
            if (data.guesser === username && data.guessed_id) {
                const wrongCard = document.querySelector(`.game-card[data-id="${data.guessed_id}"]`);
                if (wrongCard && !wrongCard.classList.contains('crossed')) {
                    wrongCard.classList.add('crossed');
                    crossedCards.add(data.guessed_id);
                    saveGameState();
                }
                myWrongGuesses++;
                await showModal('Wrong Guess', `Wrong guess! You have ${3 - myWrongGuesses} guesses left.`);
            } else {
                await showModal('Wrong Guess', `Wrong guess by Opponent!`);
            }
        }
    });

    socket.on('game_over', async data => {
      let message = '';
      const winnerIsMe = data.winner === username;
      const winnerName = winnerIsMe ? "You" : "Opponent";
      const verb = winnerIsMe ? "win" : "wins";

      if (data.reason === 'surrender') {
        message = `${winnerName} ${verb}! Opponent surrendered.`;
      } else if (data.reason === 'too_many_wrong_guesses') {
        message = `${winnerName} ${verb}! Opponent made 3 wrong guesses.`;
      } else if (data.correct_meme_name) {
        message = `${winnerName} ${verb}! It was ${data.correct_meme_name}`;
      } else {
        message = `${winnerName} ${verb}!`;
      }
      
      await showModal('Game Over', message);

      // Clear saved state
      sessionStorage.removeItem(`gameState_${roomCode}`);

      // Both players go to result page with winner info
      setTimeout(() => {
        location.href = `/result.html?room=${roomCode}&username=${encodeURIComponent(username)}&winner=${encodeURIComponent(data.winner)}`;
      }, 1000);
    });

    async function surrenderGame() {
      const confirmed = await showModal('Surrender?', 'Give up and lose the game?', true);
      if (confirmed) {
        // Get opponent's actual username
        const opponent = opponentUsername || 'Opponent';
        
        socket.emit('surrender', { room_code: roomCode, username });
        sessionStorage.removeItem(`gameState_${roomCode}`);
        
        // Navigate to result page as loser
        location.href = `/result.html?room=${roomCode}&username=${encodeURIComponent(username)}&winner=${encodeURIComponent(opponent)}`;
      }
    }

    socket.on('player_disconnected', async data => {
      await showModal('Player Disconnected', `${data.username} disconnected. You win by default!`);
      sessionStorage.removeItem(`gameState_${roomCode}`);
      
      // Navigate to result page as winner
      location.href = `/result.html?room=${roomCode}&username=${encodeURIComponent(username)}&winner=${encodeURIComponent(username)}`;
    });
  </script>
</body>
</html>