<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guess the MEME - Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Dokdo&family=Bungee+Inline&display=swap" rel="stylesheet"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#1E1E2F;
      color:white;
      font-family:'Dokdo', sans-serif;
      height:100vh;
      overflow:hidden;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    
    .back {
      position: absolute;
      top: 1.5vh;
      left: 1vw;
      display: flex;
      gap: 0.5vw;
      align-items: center;
      cursor: pointer;
      font-family: 'Bungee Inline';
      font-size: clamp(18px, 1.8vw, 32px);
      color: #fff;
      z-index: 100;
    }
    .back:hover { opacity:0.8; }

    main {
      width: 95vw;
      max-width: 1400px;
      height: 95vh;
      position: relative;
      padding: 2vh 2vw;
      display: flex;
      flex-direction: column;
    }
    
    #turnIndicator {
      font-size: clamp(32px, 4vh, 64px);
      color: #fff;
      margin-bottom: 2vh;
      text-align: center;
    }

    .content-wrapper {
      display: flex;
      gap: 2vw;
      height: 100%;
    }

    .left-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .game-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: clamp(10px, 1.5vh, 25px) clamp(8px, 1vw, 23px);
      flex: 1;
    }
    
    .game-card {
      width: 100%;
      height: 100%;
      max-width: 152px;
      max-height: 195px;
      position: relative;
      cursor: pointer;
      transition: all .25s ease;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* Hover for all cards */
    .game-card:hover:not(.selected):not(.crossed) {
      transform: scale(1.08);
      z-index: 10;
    }

    /* Selected state - strong visual feedback */
    .game-card.selected {
      transform: scale(1.15);
      z-index: 20;
      box-shadow: 0 0 30px #a78bfa, inset 0 0 20px rgba(167,139,250,0.4);
      outline: 5px solid #a78bfa;
      outline-offset: 4px;
    }

    /* Crossed out */
    .game-card.crossed {
      opacity: 0.4;
    }
    .game-card.crossed::after {
      content: "";
      position: absolute;
      inset: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><line x1="10" y1="90" x2="90" y2="10" stroke="red" stroke-width="12"/><line x1="10" y1="10" x2="90" y2="90" stroke="red" stroke-width="12"/></svg>') center/85% no-repeat;
    }

    .card-bg {
      position: absolute;
      inset: 0;
      border-radius: 20px;
    }
    .bg-yellow { background:#facc15; }
    .bg-red    { background:#f87171; }
    .bg-blue   { background:#60a5fa; }
    .bg-green  { background:#4ade80; }
    
    .game-card img {
      position: absolute;
      top: 10%;
      left: 7%;
      width: 86%;
      height: 67%;
      object-fit: contain;
    }
    
    .card-name {
      position: absolute;
      bottom: 8%;
      left: 0;
      width: 100%;
      text-align: center;
      font-family: 'Bungee Inline', cursive;
      color: #000;
      font-size: clamp(10px, 1vw, 15px);
      pointer-events: none;
    }

    .action-buttons {
      display: flex;
      gap: clamp(20px, 5vw, 113px);
      justify-content: center;
      margin-top: 2vh;
    }
    
    .action-btn button {
      width: clamp(150px, 15vw, 235px);
      height: clamp(40px, 5vh, 60px);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Bungee Inline', cursive;
      font-size: clamp(14px, 1.5vw, 24px);
      color: #fff;
      transition: all .2s;
    }
    
    .action-btn button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #resetBtn button { background: #de7d4a; }
    #resetBtn button:hover:not(:disabled) { background:#d06d3a; }
    #guessBtn button { background: #a78bfa; }
    #guessBtn button:hover:not(:disabled) { background:#9370db; }

    .hint {
      text-align: center;
      margin-top: 1vh;
      font-size: clamp(12px, 1.2vw, 15px);
      color: #fff;
    }

    .right-section {
      width: clamp(300px, 28vw, 421px);
      display: flex;
      flex-direction: column;
      gap: 2vh;
    }

    .your-card-area {
      background: rgba(167, 139, 250, 0.15);
      border: 2px solid #a78bfa;
      border-radius: 15px;
      padding: 1.5vh 1vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1vh;
    }
    
    .your-card-title {
      font-family: 'Bungee Inline';
      font-size: clamp(16px, 1.8vw, 24px);
      color: #a78bfa;
      text-align: center;
    }
    
    .your-card-display {
      width: clamp(100px, 10vw, 150px);
      height: clamp(130px, 13vh, 195px);
      background: #facc15;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .your-card-display .card-bg {
      border-radius: 15px;
    }
    
    .your-card-display img {
      width: 85%;
      height: 65%;
      object-fit: contain;
    }
    
    .your-card-name {
      font-family: 'Bungee Inline';
      font-size: clamp(12px, 1.2vw, 16px);
      color: #fff;
      text-align: center;
    }

    .chat-box {
      flex: 1;
      background: #374151;
      border-radius: 10px;
      padding: 1.5vh 1vw;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      font-size: clamp(16px, 1.8vw, 24px);
      margin-bottom: 1vh;
      min-height: 0;
    }
    
    .msg { 
      margin: 0.5vh 0;
      word-wrap: break-word;
    }
    .msg.you { color: #de7d4a; }
    .msg.opponent { color: #a78bfa; }
    .msg.system { color: #fff; }
    
    #messageForm {
      display: flex;
      gap: 1vw;
    }
    
    #chatInput {
      flex: 1;
      padding: clamp(8px, 1vh, 12px) clamp(10px, 1vw, 15px);
      background: #d9d9d9;
      border: none;
      border-radius: 10px;
      font-size: clamp(14px, 1.4vw, 16px);
      font-family: 'Bungee Inline', cursive;
      outline: none;
    }
    
    #chatInput::placeholder {
      color: #37415180;
    }
    
    #sendBtn {
      width: clamp(40px, 4vw, 54px);
      height: clamp(40px, 4vw, 54px);
      background: #a78bfa;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
      font-size: clamp(18px, 2vw, 24px);
      transition: all .2s;
    }
    
    #sendBtn:hover {
      background: #9370db;
    }
  </style>
</head>
<body>

  <div class="back" onclick="surrenderGame()">Surrender</div>

  <main>
    <h1 id="turnIndicator">Loading...</h1>

    <div class="content-wrapper">
      <div class="left-section">
        <div class="game-grid" id="gameGrid"></div>
        
        <div class="action-buttons">
          <div class="action-btn" id="resetBtn"><button>Reset board</button></div>
          <div class="action-btn" id="guessBtn"><button>it's you!</button></div>
        </div>
        
        <div class="hint">Hint: Double-click a card to cross it out â€¢ Click once to select</div>
      </div>

      <div class="right-section">
        <div class="your-card-area">
          <div class="your-card-title">YOUR MEME:</div>
          <div class="your-card-display" id="yourCard">
            <div class="card-bg" id="yourCardBg"></div>
            <img id="yourCardImg" src="" alt=""/>
          </div>
          <div class="your-card-name" id="yourCardName"></div>
        </div>

        <div class="chat-box">
          <div id="chatMessages">
            <div class="msg system">Game started!</div>
          </div>
          <form id="messageForm">
            <input type="text" id="chatInput" placeholder="Ask a question..." autocomplete="off"/>
            <button id="sendBtn" type="submit">âž¤</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(location.search);
    const roomCode = params.get('room');
    const username = params.get('username');
    const myChoiceId = parseInt(params.get('choice'));
    const firstTurn = params.get('turn');
    let selectedCard = null;
    let isMyTurn = false;
    let opponentUsername = null;
    let turnInitialized = false;
    let myWrongGuesses = 0; // Track my wrong guesses

    console.log('ðŸŽ® ===== GAME.HTML LOADED =====');
    console.log('ðŸ“‹ URL Parameters:', { roomCode, username, myChoiceId, firstTurn });

    if (!roomCode || !username || !myChoiceId) {
      console.error('âŒ Missing required parameters!');
      alert("Missing game data. Returning to menu...");
      location.href = '/';
    }

    console.log('âœ… All required parameters present');
    socket.emit('join_game_room', { room_code: roomCode, username });

    const memes = [
      {id:1, name:"Doubter", img:"/static/img/1.png", color:"yellow"},
      {id:2, name:"Conspiracy Keanu", img:"/static/img/2.png", color:"red"},
      {id:3, name:"Mini Keanu", img:"/static/img/3.png", color:"blue"},
      {id:4, name:"Eye Roll", img:"/static/img/4.png", color:"green"},
      {id:5, name:"Guard", img:"/static/img/5.png", color:"yellow"},
      {id:6, name:"Pointing Glasses", img:"/static/img/6.png", color:"red"},
      {id:7, name:"Looking Guy", img:"/static/img/7.png", color:"blue"},
      {id:8, name:"Borat Thumbs", img:"/static/img/8.png", color:"green"},
      {id:9, name:"Confused Woman", img:"/static/img/9.png", color:"yellow"},
      {id:10, name:"Smirk", img:"/static/img/10.png", color:"red"},
      {id:11, name:"Roll Safe", img:"/static/img/11.png", color:"blue"},
      {id:12, name:"Gandalf", img:"/static/img/12.png", color:"green"},
      {id:13, name:"Sad Affleck", img:"/static/img/13.png", color:"yellow"},
      {id:14, name:"Tada Man", img:"/static/img/14.png", color:"red"},
      {id:15, name:"Confused Gandalf", img:"/static/img/15.png", color:"blue"}
    ];

    // Show your meme
    const myMeme = memes.find(m => m.id === myChoiceId);
    if (myMeme) {
      document.getElementById('yourCardImg').src = myMeme.img;
      document.getElementById('yourCardName').textContent = myMeme.name;
      document.getElementById('yourCardBg').className = `card-bg bg-${myMeme.color}`;
    }

    // Build grid
    const grid = document.getElementById('gameGrid');
    memes.forEach(m => {
      const card = document.createElement('div');
      card.className = 'game-card';
      card.dataset.id = m.id;
      card.innerHTML = `
        <div class="card-bg bg-${m.color}"></div>
        <img src="${m.img}" alt="${m.name}"/>
        <div class="card-name">${m.name}</div>
      `;

      // Double-click = cross out (ANYTIME - no turn restriction)
      card.ondblclick = (e) => {
        e.stopPropagation();
        card.classList.toggle('crossed');
        if (card.classList.contains('selected')) {
          card.classList.remove('selected');
          selectedCard = null;
        }
      };

      // Single click = select for guessing (only during your turn)
      card.onclick = () => {
        if (!isMyTurn) return;
        
        // If clicking the same card, deselect it
        if (card.classList.contains('selected')) {
          card.classList.remove('selected');
          selectedCard = null;
          return;
        }

        // Clear previous selection
        document.querySelectorAll('.game-card.selected').forEach(c => c.classList.remove('selected'));
        
        // Select new one (only if not crossed out)
        if (!card.classList.contains('crossed')) {
          card.classList.add('selected');
          selectedCard = parseInt(card.dataset.id);
        }
      };

      grid.appendChild(card);
    });

    const guessBtn = document.querySelector('#guessBtn button');
    const resetBtn = document.querySelector('#resetBtn button');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    // Function to update UI based on turn
    function updateTurnUI(myTurnNow, currentPlayer) {
      console.log('ðŸ”„ ===== UPDATE TURN UI CALLED =====');
      console.log('ðŸ“Š Parameters:', { myTurnNow, currentPlayer, username });
      
      isMyTurn = myTurnNow;
      turnInitialized = true;
      
      // Update turn indicator with actual username
      const indicator = document.getElementById('turnIndicator');
      if (isMyTurn) {
        indicator.textContent = 'Your turn.';
      } else {
        indicator.textContent = `${currentPlayer}'s turn.`;
      }
      
      // Only disable guess button based on turn
      guessBtn.disabled = !isMyTurn;
      
      // Clear selection if it's not your turn
      if (!isMyTurn) {
        document.querySelectorAll('.game-card.selected').forEach(c => c.classList.remove('selected'));
        selectedCard = null;
      }
      
      console.log('âœ… Turn UI updated');
    }

    // Initialize turn from URL parameter if available
    if (firstTurn) {
      console.log('ðŸŽ¯ Initializing turn from URL');
      const initialTurn = firstTurn === username;
      updateTurnUI(initialTurn, firstTurn);
    } else {
      console.log('âš ï¸ No turn parameter in URL');
      guessBtn.disabled = true;
    }

    // Turn update from server
    socket.on('turn_update', data => {
      console.log('ðŸ“¡ Received turn_update:', data);
      updateTurnUI(data.current_turn === username, data.current_turn);
    });

    // Request turn update if not initialized after 2 seconds
    setTimeout(() => {
      if (!turnInitialized) {
        console.log('âš ï¸ Requesting turn update from server');
        socket.emit('request_turn_update', { room_code: roomCode });
      }
    }, 2000);

    // "It's you!" button
    guessBtn.onclick = () => {
      if (!isMyTurn) {
        alert("It's not your turn!");
        return;
      }
      if (!selectedCard) {
        alert("Select a card first by clicking on it!");
        return;
      }
      
      console.log('ðŸŽ¯ Making guess:', selectedCard);
      socket.emit('make_guess', { room_code: roomCode, username, guessed_id: selectedCard });
      
      // Clear selection after guess
      document.querySelectorAll('.game-card.selected').forEach(c => c.classList.remove('selected'));
      selectedCard = null;
    };

    // Reset board button (ANYTIME - no turn restriction)
    resetBtn.onclick = () => {
      console.log('ðŸ”„ Resetting board');
      document.querySelectorAll('.game-card.crossed').forEach(c => c.classList.remove('crossed'));
    };

    // Chat functionality (ANYTIME - no turn restriction)
    socket.on('chat_message', data => {
      console.log('ðŸ’¬ Received chat_message:', data);
      const div = document.createElement('div');
      const isMe = data.username === username;
      div.className = `msg ${isMe ? 'you' : 'opponent'}`;
      div.textContent = `${data.username}: ${data.message}`;
      
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    document.getElementById('messageForm').onsubmit = e => {
      e.preventDefault();
      if (!chatInput.value.trim()) return;
      
      console.log('ðŸ“¤ Sending chat message:', chatInput.value.trim());
      socket.emit('chat_message', { 
        room_code: roomCode, 
        username, 
        message: chatInput.value.trim() 
      });
      chatInput.value = '';
    };

    // Guess result
    socket.on('guess_result', data => {
      console.log('ðŸŽ¯ Received guess_result:', data);
      
      if (data.success) {
        alert(`Correct! ${data.guesser} wins! It was ${data.correct_meme_name}`);
      } else {
        // Auto-cross the wrong guess
        if (data.guessed_id) {
          const wrongCard = document.querySelector(`.game-card[data-id="${data.guessed_id}"]`);
          if (wrongCard && !wrongCard.classList.contains('crossed')) {
            wrongCard.classList.add('crossed');
            console.log('âŒ Auto-crossed wrong guess:', data.guessed_id);
          }
        }
        
        // Track wrong guesses
        if (data.guesser === username) {
          myWrongGuesses++;
          console.log(`âŒ Wrong guesses: ${myWrongGuesses}/3`);
          alert(`Wrong guess! You have ${3 - myWrongGuesses} guesses left.`);
        } else {
          alert(`Wrong guess by ${data.guesser}!`);
        }
      }
    });

    // Game over
    socket.on('game_over', data => {
      console.log('ðŸ Game over:', data);
      
      let message = '';
      if (data.reason === 'surrender') {
        message = `${data.winner} wins! Opponent surrendered.`;
      } else if (data.reason === 'too_many_wrong_guesses') {
        message = `${data.winner} wins! ${data.loser} made 3 wrong guesses.`;
      } else if (data.correct_meme_name) {
        message = `${data.winner} wins! It was ${data.correct_meme_name}`;
      } else {
        message = `${data.winner} wins!`;
      }
      
      alert(message);
      
      setTimeout(() => {
        location.href = `/result.html?room=${roomCode}&username=${encodeURIComponent(username)}`;
      }, 2000);
    });

    // Surrender function
    function surrenderGame() {
      if (confirm("Surrender and lose the game?")) {
        console.log('ðŸ³ï¸ Surrendering game...');
        socket.emit('surrender', { room_code: roomCode, username });
        location.href = `/result.html?room=${roomCode}&username=${encodeURIComponent(username)}&surrender=true`;
      }
    }

    // Handle disconnection
    socket.on('player_disconnected', data => {
      console.log('ðŸ”Œ Player disconnected:', data);
      alert(`${data.username} disconnected. Game over.`);
      location.href = '/';
    });

    // Log all socket events for debugging
    socket.onAny((eventName, ...args) => {
      console.log('ðŸ“¡ Socket event received:', eventName, args);
    });
  </script>
</body>
</html>