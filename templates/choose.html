<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guess the MEME - Choose</title>
  <link href="https://fonts.googleapis.com/css2?family=Dokdo&family=Bungee+Inline&display=swap" rel="stylesheet"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#1E1E2F; color:white; font-family:'Dokdo',sans-serif; height:100vh; overflow:hidden; }
    .back {
      position: absolute;
      top: 27px;
      left: 14px;
      display: flex;
      gap: 7px;
      align-items: center;
      cursor: pointer;
      font-family: 'Bungee Inline';
      font-size: 32px;
      color: #fff;
      z-index: 100;
    }
    .back:hover { opacity:0.8; }
    #tutorialOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.9);
      display:flex; align-items:center; justify-content:center;
      z-index:999; flex-direction:column; gap:30px; font-size:60px; text-align:center;
      opacity:1; transition:opacity 0.8s ease-out;
    }
    #tutorialOverlay.hidden { opacity:0; pointer-events:none; }
    #chooseScreen { display:none; flex-direction:column; align-items:center; padding:40px 40px 20px; }
    #chooseScreen.active { display:flex; }
    
    /* HEADER WITH CHOSEN INDICATOR */
    .header-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 10px;
    }
    #chooseScreen h1 { 
      font-size:50px; 
      color:#a78bfa; 
      text-shadow:0 0 15px #a78bfa88; 
      margin: 0;
    }
    #chosenIndicator {
      display: none;
      align-items: center;
      gap: 15px;
      background: rgba(167, 139, 250, 0.2);
      padding: 10px 20px;
      border-radius: 15px;
      border: 2px solid #a78bfa;
    }
    #chosenIndicator.active {
      display: flex;
    }
    #chosenIndicator img {
      width: 60px;
      height: 60px;
      border-radius: 10px;
    }
    #chosenIndicator span {
      font-family: 'Bungee Inline';
      font-size: 24px;
      color: #a78bfa;
    }
    
    #timer { font-size:32px; color:#FACC15; margin:0 0 20px; }
    .cards-grid {
      display:grid;
      grid-template-columns:repeat(5, 152px);
      grid-template-rows:repeat(3, 195px);
      gap:15px;
      justify-content:center;
    }
    .meme-btn {
      width:152px; height:195px; background:none; border:none; cursor:pointer; position:relative;
      transition:transform .2s, opacity .3s;
    }
    .meme-btn:hover { transform:translateY(-8px); }
    .meme-btn.grayed-out {
      opacity: 0.3;
      pointer-events: none;
      filter: grayscale(100%);
    }
    .meme-btn.chosen {
      opacity: 1;
      filter: none;
      box-shadow: 0 0 30px #a78bfa;
      transform: scale(1.05);
    }
    .meme-bg { position:absolute; inset:0; border-radius:20px; }
    .meme-bg.yellow { background:#facc15; }
    .meme-bg.red { background:#f87171; }
    .meme-bg.blue { background:#60a5fa; }
    .meme-bg.green { background:#4ade80; }
    .meme-btn img { width:130px; height:130px; position:absolute; top:15px; left:11px; pointer-events:none; }
    .meme-btn span {
      position:absolute; bottom:15px; left:0; width:100%; text-align:center;
      font-family:'Bungee Inline',cursive; color:#000; font-size:15px; pointer-events:none;
    }

    /* CONFIRM MODAL */
    #confirmModal {
      position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none;
      align-items:center; justify-content:center; z-index:1000;
    }
    #confirmModal.active { display:flex; }

    .box {
      position: relative;
      width: 700px;
      height: 500px;
    }
    .box .rectangle {
      width: 700px;
      height: 500px;
      position: absolute;
      top: 0;
      left: 0;
      border-radius: 10px;
    }
    .box.yellow .rectangle  { background-color: #facc15; }
    .box.red .rectangle    { background-color: #f87171; }
    .box.blue .rectangle   { background-color: #60a5fa; }
    .box.green .rectangle  { background-color: #4ade80; }

    .box .doodle-character {
      position: absolute;
      top: 31px;
      left: 37px;
      width: 130px;
      height: 130px;
    }
    .box .text-wrapper-3 {
      position: absolute;
      top: 77px;
      left: 202px;
      font-family: "Bungee Inline", Helvetica;
      font-weight: 400;
      color: #000000;
      font-size: 32px;
      white-space: nowrap;
    }
    .box .description {
      position: absolute;
      top: 187px;
      left: 54px;
      font-family: "Bungee Inline", Helvetica;
      font-weight: 400;
      color: #000000;
      font-size: 20px;
      line-height: normal;
    }

    .box .action-buttons {
      position: absolute;
      bottom: 37px;
      left: 80px;
      right: 77px;
      display: flex;
      justify-content: space-between;
      gap: 73px;
      z-index: 2;
    }
    .box .choose,
    .box .change {
      position: relative;
      width: 237px;
      height: 60px;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }
    .box .choose:hover,
    .box .change:hover { transform: translateY(-2px); opacity: 0.9; }
    .box .choose:active,
    .box .change:active { transform: translateY(0); }

    .box .div,
    .box .rectangle-2 {
      width: 235px;
      height: 60px;
      position: absolute;
      top: 0;
      left: 0;
      border-radius: 10px;
      pointer-events: none;
    }
    .box .div        { background-color: #a78bfa; }
    .box .rectangle-2 { background-color: #de7d4a; }

    .box .text-wrapper,
    .box .text-wrapper-2 {
      position: absolute;
      top: calc(50% - 14px);
      font-family: "Bungee Inline", Helvetica;
      font-weight: 400;
      color: #ffffff;
      font-size: 24px;
      pointer-events: none;
    }
    .box .text-wrapper   { left: calc(50% - 90px); }
    .box .text-wrapper-2 { left: calc(50% - 114px); }
  </style>
</head>
<body>
  <div class="back" onclick="location.href='/'">
    Back
  </div>
  
  <div id="tutorialOverlay">
    <div>READY...</div>
    <div style="font-size:100px;">PICK A MEME</div>
    <div>Your opponent will guess it!</div>
  </div>
  
  <div id="chooseScreen">
    <div class="header-row">
      <h1>CHOOSE A MEME:</h1>
      <div id="chosenIndicator">
        <img id="chosenImg" src="" alt=""/>
        <span id="chosenName"></span>
      </div>
    </div>
    <div id="timer">Time remaining: 10s</div>
    <div class="cards-grid" id="chooseCards"></div>
  </div>

  <!-- CONFIRM MODAL -->
  <div id="confirmModal">
    <div class="box" id="modalBox">
      <div class="rectangle"></div>
      <img class="doodle-character" id="modalImg" src="" alt=""/>
      <div class="text-wrapper-3" id="modalName"></div>
      <div class="description">Is this the meme you want?</div>
      <nav class="action-buttons">
        <button class="change" id="cancelBtn">
          <div class="rectangle-2"></div>
          <span class="text-wrapper-2">Choose another</span>
        </button>
        <button class="choose" id="confirmBtn">
          <div class="div"></div>
          <span class="text-wrapper">Yes, choose!</span>
        </button>
      </nav>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(location.search);
    const roomCode = params.get('room') || 'TEST';
    const username = params.get('username') || 'Player';

    console.log('Choose screen loaded:', { roomCode, username });

    socket.emit('join_game_room', { room_code: roomCode, username });
    socket.emit('player_ready', { room_code: roomCode, username });

    const memes = [
      {id:1, name:"Doubter", img:"/static/img/1.png", color:"yellow"},
      {id:2, name:"Conspiracy Keanu", img:"/static/img/2.png", color:"red"},
      {id:3, name:"Mini Keanu", img:"/static/img/3.png", color:"blue"},
      {id:4, name:"Eye Roll", img:"/static/img/4.png", color:"green"},
      {id:5, name:"Guard", img:"/static/img/5.png", color:"yellow"},
      {id:6, name:"Pointing Glasses", img:"/static/img/6.png", color:"red"},
      {id:7, name:"Looking Guy", img:"/static/img/7.png", color:"blue"},
      {id:8, name:"Borat Thumbs", img:"/static/img/8.png", color:"green"},
      {id:9, name:"Confused Woman", img:"/static/img/9.png", color:"yellow"},
      {id:10, name:"Smirk", img:"/static/img/10.png", color:"red"},
      {id:11, name:"Roll Safe", img:"/static/img/11.png", color:"blue"},
      {id:12, name:"Gandalf", img:"/static/img/12.png", color:"green"},
      {id:13, name:"Sad Affleck", img:"/static/img/13.png", color:"yellow"},
      {id:14, name:"Tada Man", img:"/static/img/14.png", color:"red"},
      {id:15, name:"Confused Gandalf", img:"/static/img/15.png", color:"blue"}
    ];

    let myChoice = null;
    let chooseTimerId = null;
    let hasChosen = false;

    const tutorialOverlay = document.getElementById('tutorialOverlay');
    const chooseScreen = document.getElementById('chooseScreen');
    const chooseGrid = document.getElementById('chooseCards');
    const timerDisplay = document.getElementById('timer');
    const chosenIndicator = document.getElementById('chosenIndicator');

    // Show tutorial for 3s, then show choose screen
    setTimeout(() => {
      tutorialOverlay.classList.add('hidden');
      setTimeout(() => {
        tutorialOverlay.style.display = 'none';
        chooseScreen.classList.add('active');
      }, 800);
    }, 3000);

    // Listen for choose phase start from server
    socket.on('choose_phase_start', () => {
      console.log('Choose phase started by server');
      if (!chooseScreen.classList.contains('active')) {
        chooseScreen.classList.add('active');
      }
      startChoosePhase();
    });

    function startChoosePhase() {
      console.log('Starting choose phase UI');
      
      if (chooseTimerId) {
        console.log('Choose phase already running');
        return;
      }
      
      chooseGrid.innerHTML = '';
      memes.forEach(m => {
        const btn = document.createElement('button');
        btn.className = 'meme-btn';
        btn.dataset.id = m.id;
        btn.innerHTML = `<div class="meme-bg ${m.color}"></div>
                         <img src="${m.img}" alt="${m.name}"/>
                         <span>${m.name}</span>`;
        btn.onclick = () => showConfirm(m);
        chooseGrid.appendChild(btn);
      });

      let time = 10;
      timerDisplay.textContent = `Time remaining: ${time}s`;
      chooseTimerId = setInterval(() => {
        time--;
        timerDisplay.textContent = `Time remaining: ${time}s`;
        if (time <= 0) {
          clearInterval(chooseTimerId);
          timerDisplay.textContent = "Time's up! Waiting for opponent...";
        }
      }, 1000);
    }
    
    setTimeout(() => {
      if (chooseScreen.classList.contains('active') && !chooseTimerId) {
        console.log('Auto-starting choose phase (fallback)');
        startChoosePhase();
      }
    }, 4000);

    function showConfirm(meme) {
      if (hasChosen) return;
      
      document.getElementById('modalImg').src = meme.img;
      document.getElementById('modalName').textContent = meme.name;
      const box = document.getElementById('modalBox');
      box.className = 'box ' + meme.color;
      document.getElementById('confirmModal').classList.add('active');
      window.selectedMeme = meme;
    }

    document.getElementById('cancelBtn').onclick = () => {
      if (hasChosen) return;
      document.getElementById('confirmModal').classList.remove('active');
    };

    document.getElementById('confirmBtn').onclick = () => {
      if (hasChosen) return;
      
      myChoice = window.selectedMeme;
      hasChosen = true;
      
      console.log('âœ… Player confirmed choice:', myChoice.id);
      
      // Close modal
      document.getElementById('confirmModal').classList.remove('active');
      
      // Show chosen indicator at top
      document.getElementById('chosenImg').src = myChoice.img;
      document.getElementById('chosenName').textContent = myChoice.name;
      chosenIndicator.classList.add('active');
      
      // Gray out all other cards
      const allCards = document.querySelectorAll('.meme-btn');
      allCards.forEach(card => {
        const cardId = parseInt(card.dataset.id);
        if (cardId === myChoice.id) {
          card.classList.add('chosen');
        } else {
          card.classList.add('grayed-out');
        }
        card.onclick = null; // Disable clicking
      });
      
      // Stop timer
      if (chooseTimerId) clearInterval(chooseTimerId);
      timerDisplay.textContent = 'Waiting for opponent...';
      
      // Send choice to server
      console.log('ðŸ“¤ Emitting player_chose event');
      socket.emit('player_chose', { 
        room_code: roomCode, 
        username, 
        choice: myChoice.id 
      });
    };

    // Listen for redirect to gameplay after both players chose (or timer ended)
    socket.on('redirect_to_gameplay', data => {
      console.log('ðŸŽ® REDIRECT EVENT RECEIVED:', data);
      const url = `/game.html?room=${data.room_code}&username=${encodeURIComponent(data.username)}&choice=${data.choice}`;
      console.log('ðŸŽ® Redirecting to:', url);
      window.location.href = url;
    });

    socket.on('choices_finalized', data => {
      console.log('âœ… Choices finalized:', data);
    });

    socket.onAny((eventName, ...args) => {
      console.log('ðŸ“¡ Socket event:', eventName, args);
    });
  </script>
</body>
</html>