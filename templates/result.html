<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Result Room</title>
  <link href="https://fonts.googleapis.com/css2?family=Dokdo&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='globals.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #1E1E2F;
      color: #fff;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .leave-join-room {
      width: min(100vw, 1440px);
      height: min(100vh, 1024px);
      position: relative;
      flex-shrink: 0;
    }

    .box {
      position: absolute;
      top: calc(50% - 275px);
      left: calc(50% - 598px);
      width: 833px;
      height: 554px;
    }

    .box .rectangle {
      position: absolute;
      inset: 0;
      background: #d9d9d91a;
      border: 3px dashed #9ca3af;
      border-radius: 20px;
    }

    .left-area {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .you-won {
      font-family: 'Bungee Inline', cursive;
      font-size: clamp(50px, 6.25vw, 90px);
      text-shadow: 0 0 20px currentColor;
      margin: 25px 0 10px;
    }

    .medal-img {
      width: clamp(150px, 18vw, 260px);
      margin-top: 30px;
    }

    .leave-btn, .playagain-btn {
      position: absolute;
      width: clamp(190px, 19.1vw, 275px);
      height: clamp(38px, 5.37vh, 55px);
      border-radius: 10px;
      text-align: center;
      line-height: clamp(38px, 5.37vh, 55px);
      font-family: 'Bungee Inline', cursive;
      font-size: clamp(22px, 2.22vw, 32px);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .leave-btn    { top: 325px; left: 1031px; background: #10B981; }
    .playagain-btn { top: 510px; left: 1031px; background: #60A5FA; }

    .leave-btn.disabled, .playagain-btn.disabled {
      background: #4B5563 !important;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .leave-btn:hover:not(.disabled) { background: #EF4444; }
    .playagain-btn:hover:not(.disabled) { background: #316ac7; }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(30, 30, 47, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #1E1E2F;
      padding: clamp(30px, 4vw, 40px);
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 0 20px #000;
      max-width: 90%;
    }

    .modal-text {
      font-family: 'Bungee Inline', cursive;
      font-size: clamp(28px, 4vw, 36px);
      margin-bottom: 20px;
      color: #a78bfa;
    }

    .modal-message {
      font-family: 'Dokdo', cursive;
      font-size: clamp(18px, 3vw, 28px);
      margin-bottom: 30px;
      color: #fff;
      line-height: 1.4;
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .modal-buttons button {
      font-family: 'Bungee Inline', cursive;
      font-size: clamp(22px, 2.8vw, 28px);
      padding: 10px 30px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: #fff;
      min-width: 120px;
    }

    .modal-buttons .btn-primary {
      background: #10B981;
    }

    .modal-buttons .btn-primary:hover {
      background: #059669;
    }

    .modal-buttons .btn-secondary {
      background: #EF4444;
    }

    .modal-buttons .btn-secondary:hover {
      background: #DC2626;
    }

    .chat-box {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: clamp(300px, 30vw, 400px);
      max-height: 400px;
      background: #374151;
      border-radius: 10px;
      padding: 1.5vh 1vw;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    #chatMessages {
      flex: 1;
      overflow-y: auto;
      font-size: clamp(16px, 1.8vw, 24px);
      margin-bottom: 1vh;
      font-family: 'Dokdo', cursive;
    }

    .msg { margin: 0.5vh 0; word-wrap: break-word; }
    .msg.you { color: #de7d4a; }
    .msg.opponent { color: #a78bfa; }

    #messageForm { display: flex; gap: 1vw; align-items: center; }
    #chatInput {
      flex: 1;
      padding: 8px 10px;
      background: #d9d9d9;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-family: 'Bungee Inline', cursive;
      outline: none;
    }
    #sendBtn {
      width: 50px;
      height: 50px;
      background: #a78bfa;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
      font-size: 20px;
    }
    #sendBtn:hover { background: #9370db; }
  </style>
</head>
<body>

<div class="leave-join-room">
  <div class="box">
    <div class="rectangle"></div>
    <div class="left-area">
      <div class="you-won" id="resultText">YOU WON!</div>
      <img src="{{ url_for('static', filename='img/goldmedal.png')}}" class="medal-img" id="medalImg">
    </div>
  </div>

  <div class="leave-btn" id="leaveMainBtn">Leave room</div>
  <div class="playagain-btn" id="playagainMainBtn">Play again (0/2)</div>
</div>

<div id="leaveModal" class="modal">
  <div class="modal-content">
    <div class="modal-text">Leave Room?</div>
    <div class="modal-message">Are you sure you want to leave the game?</div>
    <div class="modal-buttons">
      <button id="cancelLeaveBtn" class="btn-primary">No</button>
      <button id="confirmLeaveBtn" class="btn-secondary">Yes</button>
    </div>
  </div>
</div>

<div id="disconnectModal" class="modal">
  <div class="modal-content">
    <div class="modal-text">Player Disconnected</div>
    <div class="modal-message" id="disconnectMessage">Opponent left the room. Returning to menu...</div>
    <div class="modal-buttons">
      <button id="disconnectOkBtn" class="btn-primary">OK</button>
    </div>
  </div>
</div>

<div class="chat-box">
  <div id="chatMessages"></div>
  <form id="messageForm">
    <input type="text" id="chatInput" placeholder="Enter a message...." autocomplete="off"/>
    <button id="sendBtn" type="submit">âž¤</button>
  </form>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io({
  transports: ['websocket', 'polling'],
  upgrade: true,
  rememberUpgrade: true,
  forceNew: true
});

const playBtn = document.getElementById("playagainMainBtn");
const leaveBtn = document.getElementById("leaveMainBtn");
const params = new URLSearchParams(window.location.search);

// Get room code and username from URL params (primary) or Flask template (fallback)
const roomCode = params.get('room') || "{{ room_code }}";
const username = params.get('username') || "{{ username }}";

console.log(`[RESULT] Room: ${roomCode}, Username: ${username}`);

const statusText = document.getElementById("resultText");
const medalImg = document.getElementById("medalImg");

const winMedal = "{{ url_for('static', filename='img/goldmedal.png') }}";
const loseMedal = "{{ url_for('static', filename='img/silvermedal.png') }}";

const winner = params.get("winner");
const isWinner = username === winner;

// Set win/loss display
if (isWinner) {
  statusText.textContent = "YOU WON!";
  statusText.style.color = "#ffea00";
  statusText.style.textShadow = "0 0 20px #ffea00";
  medalImg.src = winMedal;
} else {
  statusText.textContent = "YOU LOST!";
  statusText.style.color = "#3b82f6";
  statusText.style.textShadow = "0 0 20px #3b82f6";
  medalImg.src = loseMedal;
}

let hasClicked = false;
let playersReady = 0;
const totalPlayers = 2;
let opponentUsername = null;

console.log(`[RESULT] Loaded result page for ${username} in room ${roomCode}`);

socket.on('connect', () => {
  console.log(`[RESULT] Socket connected: ${socket.id}`);
  // Join the result room
  socket.emit('join_result_room', { room_code: roomCode, username });
  console.log(`[RESULT] Emitted join_result_room`);
});

// Listen for player updates
socket.on('update_players', players => {
  console.log(`[RESULT] Players in room:`, players);
  opponentUsername = players.find(p => p !== username);
  console.log(`[RESULT] Opponent: ${opponentUsername}`);
});

// Listen for ready count updates
socket.on('update_ready_count', (data) => {
  console.log(`[RESULT] Received ready count update:`, data);
  playersReady = data.ready_players;
  
  if (hasClicked) {
    playBtn.innerText = `PLAY AGAIN (${playersReady}/${totalPlayers}) waiting...`;
    playBtn.classList.add('disabled');
  } else {
    playBtn.innerText = `PLAY AGAIN (${playersReady}/${totalPlayers})`;
    playBtn.classList.remove('disabled');
  }
});

// Handle play again click
playBtn.onclick = () => {
  if (hasClicked) {
    console.log(`[RESULT] Already clicked, ignoring`);
    return;
  }
  
  console.log(`[RESULT] Play again clicked by ${username}`);
  hasClicked = true;
  playBtn.classList.add('disabled');
  playBtn.innerText = `PLAY AGAIN (${playersReady + 1}/${totalPlayers}) waiting...`;
  
  socket.emit('player_ready', { room_code: roomCode, username });
  console.log(`[RESULT] Emitted player_ready`);
};

// Listen for redirect to new game
socket.on('redirect_to_game', (data) => {
  console.log(`[RESULT] Received redirect_to_game`, data);
  window.location.href = `/choose.html?room=${roomCode}&username=${encodeURIComponent(username)}`;
});

// Leave room functionality
const leaveModal = document.getElementById("leaveModal");
leaveBtn.onclick = () => leaveModal.style.display = "flex";

document.getElementById("confirmLeaveBtn").onclick = () => {
  socket.emit('leave_game', { room_code: roomCode, username });
  window.location.href = "/";
};

document.getElementById("cancelLeaveBtn").onclick = () => {
  leaveModal.style.display = "none";
};

window.onclick = (e) => {
  if (e.target === leaveModal) leaveModal.style.display = "none";
};

// Chat functionality
const chatInput = document.getElementById('chatInput');

socket.on('chat_message', data => {
  console.log(`[RESULT CHAT] Received message:`, data);
  const div = document.createElement('div');
  const isMe = data.username === username;
  div.className = `msg ${isMe ? 'you' : 'opponent'}`;
  const sender = isMe ? "You" : "Opponent";
  div.textContent = `${sender}: ${data.message}`;
  document.getElementById('chatMessages').appendChild(div);
  document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
});

document.getElementById('messageForm').onsubmit = e => {
  e.preventDefault();
  if (!chatInput.value.trim()) return;
  console.log(`[RESULT CHAT] Sending message: ${chatInput.value.trim()}`);
  socket.emit('chat_message', { room_code: roomCode, username, message: chatInput.value.trim() });
  chatInput.value = '';
};

// Handle player disconnect with modal
const disconnectModal = document.getElementById('disconnectModal');
const disconnectMessage = document.getElementById('disconnectMessage');
const disconnectOkBtn = document.getElementById('disconnectOkBtn');

socket.on('player_disconnected', data => {
  console.log(`[RESULT] Player disconnected:`, data);
  const disconnectedPlayer = data.username || opponentUsername || 'Opponent';
  disconnectMessage.textContent = `${disconnectedPlayer} left the room. Returning to menu...`;
  disconnectModal.style.display = 'flex';
});

disconnectOkBtn.onclick = () => {
  window.location.href = '/';
};

socket.on('disconnect', () => {
  console.log(`[RESULT] Socket disconnected`);
});
</script>

</body>
</html>